{"version":3,"sources":["../../../src/common/xviz-data.js"],"names":["XVIZData","data","_data","_dataFormat","undefined","_xvizType","_message","_determineFormat","Error","msg","XVIZ_FORMAT","BINARY_GLB","Buffer","buffer","slice","byteOffset","byteLength","BINARY_PBE","JSON_BUFFER","jsonString","toString","ArrayBuffer","isView","Uint8Array","TextDecoder","decode","JSON","parse","JSON_STRING","OBJECT","xvizMsg","XVIZMessage","type","rawType","parts","split","namespace"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* global Buffer */\n/* eslint-disable complexity */\nimport {\n  getDataContainer,\n  parseBinaryXVIZ,\n  isGLBXVIZ,\n  isJSONString,\n  isPBEXVIZ,\n  getXVIZMessageType\n} from './loaders';\nimport {XVIZMessage} from './xviz-message';\nimport {TextDecoder} from './text-encoding';\nimport {XVIZ_FORMAT} from './constants';\n\n// Represents raw xviz data and\n// can create an XVIZMessage\n//\n// Assume isXVIZMessage has been called\n//\n// Raw data formats supported:\n// - JSON string\n// - arraybuffer which is a JSON string\n// - JSON object\n// - arraybuffer which is a GLB\nexport class XVIZData {\n  constructor(data) {\n    this._data = data;\n\n    // _dataFormat is an XVIZ_FORMAT for 'data'\n    this._dataFormat = undefined;\n\n    // _xvizType is the XVIZ Envelope 'type'\n    this._xvizType = undefined;\n\n    // _message is an XVIZMessage and has been fully parsed\n    this._message = undefined;\n\n    this._determineFormat();\n\n    if (!this._dataFormat) {\n      throw new Error('Unknown XVIZ data format');\n    }\n  }\n\n  get buffer() {\n    return this._data;\n  }\n\n  get format() {\n    return this._dataFormat;\n  }\n\n  // In some cases this can be as expensive as a parse, so we do not\n  // load this unless asked for explicitly.\n  get type() {\n    if (this._message) {\n      return this._message.type;\n    } else if (!this._xvizType) {\n      const rawType = getXVIZMessageType(this._data);\n      if (rawType) {\n        const parts = rawType.split('/');\n        this._xvizType = {\n          namespace: parts[0],\n          type: parts[1]\n        };\n      }\n    }\n\n    return this._xvizType.type;\n  }\n\n  hasMessage() {\n    return this._message !== undefined;\n  }\n\n  // converts data to JS object\n  message() {\n    let msg = null;\n    if (this._message) {\n      return this._message;\n    }\n\n    let data = this._data;\n    switch (this._dataFormat) {\n      case XVIZ_FORMAT.BINARY_GLB:\n        if (data instanceof Buffer) {\n          data = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n        }\n        msg = parseBinaryXVIZ(data);\n        break;\n      case XVIZ_FORMAT.BINARY_PBE:\n        if (data instanceof Buffer) {\n          data = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n        }\n        msg = parseBinaryXVIZ(data);\n        break;\n      case XVIZ_FORMAT.JSON_BUFFER:\n        let jsonString = null;\n        if (data instanceof Buffer) {\n          // Default to utf8 encoding\n          jsonString = data.toString();\n        } else if (data instanceof ArrayBuffer || ArrayBuffer.isView(data)) {\n          data = new Uint8Array(data);\n\n          // This is slow\n          jsonString = new TextDecoder('utf8').decode(data);\n        }\n\n        msg = JSON.parse(jsonString);\n        break;\n      case XVIZ_FORMAT.JSON_STRING:\n        msg = JSON.parse(data);\n        break;\n      case XVIZ_FORMAT.OBJECT:\n        msg = data;\n        break;\n      default:\n        throw new Error(`Unsupported format ${this._dataFormat}`);\n    }\n\n    const xvizMsg = new XVIZMessage(msg);\n    if (xvizMsg.data) {\n      this._message = xvizMsg;\n      return this._message;\n    }\n\n    return null;\n  }\n\n  _determineFormat() {\n    let data = this._data;\n    switch (getDataContainer(data)) {\n      case 'binary':\n        if (data instanceof Buffer) {\n          data = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n        }\n\n        if (isPBEXVIZ(data)) {\n          this._dataFormat = XVIZ_FORMAT.BINARY_PBE;\n        } else if (isGLBXVIZ(data)) {\n          this._dataFormat = XVIZ_FORMAT.BINARY_GLB;\n        } else {\n          if (data instanceof ArrayBuffer) {\n            data = new Uint8Array(data);\n          }\n\n          if (isJSONString(data)) {\n            this._dataFormat = XVIZ_FORMAT.JSON_BUFFER;\n          }\n        }\n        break;\n      case 'string':\n        if (isJSONString(data)) {\n          this._dataFormat = XVIZ_FORMAT.JSON_STRING;\n        }\n        break;\n      case 'object':\n        this._dataFormat = XVIZ_FORMAT.OBJECT;\n        break;\n\n      default:\n    }\n  }\n}\n"],"file":"xviz-data.js"}